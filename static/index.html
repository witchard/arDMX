<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lighting</title>
    <link rel="stylesheet"  href="css/themes/default/jquery.mobile-1.3.1.min.css">
    <link rel="stylesheet"  href="css/spectrum.css">
    <script src="js/jquery.js"></script>
    <script src="js/jquery.mobile-1.3.1.min.js"></script>
    <script src="js/spectrum.js"></script>
</head>
<body>
  <div data-role="page" id="main">
    <div data-role="header" data-position="fixed">
      <p>
        <!-- Popup box to show the lights were updated -->
        <div data-role="popup" id="popupResult">
          <p>Lights updated...</p>
        </div>

        <!-- Quick menu at top of screen -->
        <div data-role="fieldcontain">
	  <button data-icon="star" id="live" data-inline="true" data-theme="b">Live</button>
          <!--<button data-icon="star" id="set" data-inline="true">Set Lights</button>-->
        </div>
      </p>
    </div>

    <div data-role="content">
      <div class="sliders">
        <!-- Empty space for our sliders -->
      </div>
      <input type="text" id="spectrum">
    </div>
  </div>
  <div data-role="page" id="dialog">
    <div data-role="header">
      <h1>Message</h1>
    </div>    
    <div data-role="content" id="dialog-text">
    </div>    
  </div>

  <script>    
    function show_dialog(text) {
      $("#dialog-text").html(text);
      $.mobile.changePage( "#dialog", { role: "dialog" } );
    }
    
    function set_lights(values) {
      // Send values as json blob
      $.ajax({
        url: "set_values", 
        data: JSON.stringify(values), 
        contentType: 'application/json',
        dataType: 'json',
        type: 'POST'})
        .done(function( json ) {
          if( !json.ok ) {
            show_dialog( "Error: " + json.message );
          } else {
            //$("#popupResult").popup("open")
            //setTimeout(function () { $("#popupResult").popup("close"); }, 1000);
          }
        })
        .fail(function( jqxhr, textStatus, error ) {
          show_dialog( "Request Failed: " + textStatus + ", " + error );
        });
    }

    $( "#main" ).on( "pageinit", function( event ) {
      // Create sliders from config data on server
      $.getJSON("config.json", function(sliders) {
        // Map to generate an array of slider html goodness
        sliders = jQuery.map( sliders, function(i) {
          return '<div data-role="fieldcontain">' +
                    '<label for="slider-' + i.channel + '">' + i.name + '</label>' +
                    '<input type="range" class="slider" name="' + i.channel + '" id="slider-' + i.channel + '" value="' + i.initial + '" min="0" max="255" data-highlight="true"/>' +
                 '</div>';
          });
        // Append them to our document
        $(".sliders").append(sliders).trigger("create");

        // Setup sliders event handling
        $(".slider").on("slidestart", slider_start);
        $(".slider").on("slidestop", slider_stop);
      });
    });

    // Handle set lights button click
    $("#set").on("click", function(event, ui) {
      // Grab info
      var values = {lights: []};
      $(".slider").each(function() {
        values.lights.push([this.name, this.value]);
      });
      set_lights(values);
    });

    // Handle live flips
    var live = true;
    $("#live").on("click", function(event, ui){
      live = !live;
      if( live ) {
        $("#live").buttonMarkup({theme: 'b'});
        $("#set").button("disable");
      } else {
        $("#live").buttonMarkup({theme: 'a'});
        $("#set").button("enable");
      }
    });

    // Handle slider starting movements
    var slider_timer = null;
    var slider = null;
    function slider_start(event) {
      // Trigger updates every 100ms
      if(live) {
        slider = event.currentTarget;
        slider_timer = setTimeout(handle_slide, 100);
      }
    }

    function handle_slide() {
      // Update slider and trigger again
      update_slider(slider);
      slider_timer = setTimeout(handle_slide, 100);
    }

    function slider_stop(event) {
      // Cancel triggering and update just to make sure we catch last value
      if(live) {
        clearTimeout(slider_timer);
        update_slider(event.currentTarget);
      }
    }

    function update_slider(slider) {
      // Post the new value
      var values = {lights: []};
      values.lights.push([slider.name, slider.value]);
      set_lights(values);
    } 

    function doMove(c) {
      values = {lights: []};
      values.lights.push([5, Math.round(c._r)]);
      values.lights.push([6, Math.round(c._g)]);
      values.lights.push([7, Math.round(c._b)]);
      set_lights(values);
    }

    $("#spectrum").spectrum({
      showPalette: true, preferredFormat: "rgb", showInput: true, move: doMove,
      palette: [
        ["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
        ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
        ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
        ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
        ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
        ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
        ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
        ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]
    ]});
    
  </script>


</body>
</html>
